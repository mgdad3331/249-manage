<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .action-buttons {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>

<header class="bg-gradient d-flex align-items-center justify-content-between p-3 mb-4" style="background: linear-gradient(90deg,#2a9df4,#ff8a33);">
    <div class="d-flex align-items-center">
        <img src="https://i.ibb.co/8nNk7gxX/logo-removebg-preview-1.png" alt="Logo" height="50" class="me-3">
        <div>
            <h1 class="h4 text-white mb-0">Management System</h1>
            <small class="text-white-50">Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</small>
        </div>
    </div>
    
    <div class="action-buttons">
        <button class="btn btn-light btn-sm fw-bold" onclick="addClient()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
        <button class="btn btn-success btn-sm fw-bold" onclick="saveChanges()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
    </div>
</header>

<main class="container-fluid">
    <div class="table-responsive shadow-sm rounded bg-white">
        <table class="table table-bordered table-hover align-middle" id="client-table">
            <thead class="table-primary">
                <tr>
                    {% if clients %}
                        {% for col in clients[0].keys() %}
                            <th class="text-center" data-col-name="{{ col }}">{{ col }}</th>
                        {% endfor %}
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for client in clients %}
                <tr data-row-index="{{ loop.index0 }}">
                    {% for col, val in client.items() %}
                        {% if col in tick_columns %}
                            <td class="text-center">
                                <input type="checkbox" class="form-check-input row-data" 
                                       data-col="{{ col }}" 
                                       {% if val == "TRUE" or val == True %}checked{% endif %}>
                            </td>
                        {% else %}
                            <td class="text-center">
                                {% if col == 'Name' %}
                                    <strong>{{ val }}</strong>
                                {% else %}
                                    {{ val }}
                                {% endif %}
                                <input type="hidden" class="row-data" data-col="{{ col }}" value="{{ val }}">
                            </td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</main>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ÙˆØ¸ÙŠÙØ© Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„
function addClient(){
    let pwd = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:");
    if(!pwd) return;
    fetch('/add_client', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({password: pwd})
    })
    .then(r=>r.json())
    .then(d=>{
        if(d.status === 'success'){
            alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ âœ…');
            location.reload();
        } else {
            alert('ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ' + (d.message || 'Ø®Ø·Ø£'));
        }
    })
}

// ÙˆØ¸ÙŠÙØ© Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ© (Bulk Save)
function saveChanges() {
    let pwd = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª:");
    if (!pwd) return;

    let updates = {};

    // Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙ„ ØµÙ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    $('#client-table tbody tr').each(function() {
        let rowIndex = $(this).data('row-index');
        updates[rowIndex] = {};

        $(this).find('.row-data').each(function() {
            let colName = $(this).data('col');
            let value;

            if ($(this).is(':checkbox')) {
                value = $(this).is(':checked') ? "TRUE" : "FALSE";
            } else {
                value = $(this).val();
            }
            updates[rowIndex][colName] = value;
        });
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³ÙŠØ±ÙØ±
    fetch('/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            password: pwd,
            updates: updates
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.status === 'success') {
            alert('ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…');
            location.reload();
        } else {
            alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + d.message);
        }
    })
    .catch(e => {
        console.error(e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
    });
}
</script>

</body>
</html>
