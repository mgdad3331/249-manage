<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management System | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<nav class="navbar navbar-dark shadow-sm mb-4">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <div class="navbar-brand d-flex align-items-center">
            <img src="https://i.ibb.co/8nNk7gxX/logo-removebg-preview-1.png" alt="Logo" height="45" class="ms-3">
            <div class="brand-text">
                <span class="fw-bold d-block">MANAGEMENT SYSTEM</span>
                <small class="text-info">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</small>
            </div>
        </div>
        
        <div class="d-flex gap-2">
            <button class="btn btn-outline-light btn-sm px-3" onclick="checkPassForAdd()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn btn-warning btn-sm px-3 fw-bold" onclick="saveAllChanges()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </div>
    </div>
</nav>

<main class="container-fluid px-4">
    <div class="card shadow-sm border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="client-table">
                <thead class="bg-light">
                    <tr>
                        {% if clients %}
                            {% for col in clients[0].keys() %}
                                <th class="text-center py-3">{{ col }}</th>
                            {% endfor %}
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for client in clients %}
                    <tr data-row="{{ loop.index0 }}">
                        {% for col, val in client.items() %}
                            {% if col in tick_columns %}
                                <td class="text-center">
                                    <div class="form-check form-switch d-inline-block">
                                        <input type="checkbox" class="form-check-input tick-input" 
                                               data-col="{{ col }}" 
                                               {% if val == "TRUE" or val == True %}checked{% endif %}>
                                    </div>
                                </td>
                            {% else %}
                                <td class="text-center text-secondary">
                                    {{ val }}
                                </td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</main>

<div class="modal fade" id="addClientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content text-end">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h5>
            </div>
            <div class="modal-body">
                <form id="newClientForm">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                        <input type="text" id="newName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" id="newEmail" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</label>
                        <input type="text" id="newUni" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="text" id="newPhone" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="submitNewClient()">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let adminPass = "";

    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù‚Ø¨Ù„ ÙØªØ­ Ø§Ù„Ø®Ø§Ù†Ø§Øª
    function checkPassForAdd() {
        let pwd = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ù„ÙˆØµÙˆÙ„:");
        if (pwd === "Miqdad123") {
            adminPass = pwd;
            var myModal = new bootstrap.Modal(document.getElementById('addClientModal'));
            myModal.show();
        } else {
            alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©!");
        }
    }

    // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø³ÙŠØ±ÙØ±
    function submitNewClient() {
        const data = {
            password: adminPass,
            name: $('#newName').val(),
            email: $('#newEmail').val(),
            uni: $('#newUni').val(),
            phone: $('#newPhone').val()
        };

        fetch('/add_client', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(r => r.json()).then(res => {
            if(res.status === 'success') location.reload();
            else alert("Ø®Ø·Ø£: " + res.message);
        });
    }

    // 3. Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ù€ Ticks Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
    function saveAllChanges() {
        let pwd = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸:");
        if (!pwd) return;

        let updates = {};
        $('#client-table tbody tr').each(function() {
            let rowIndex = $(this).data('row');
            updates[rowIndex] = {};
            $(this).find('.tick-input').each(function() {
                updates[rowIndex][$(this).data('col')] = $(this).is(':checked') ? "TRUE" : "FALSE";
            });
        });

        fetch('/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ password: pwd, updates: updates })
        }).then(r => r.json()).then(res => {
            if(res.status === 'success') alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            else alert("ÙØ´Ù„: " + res.message);
        });
    }
</script>
    <script>
// 1. ÙˆØ¸ÙŠÙØ© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
function enableEdit(btn) {
    let pwd = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„:");
    if (pwd === "Miqdad123") {
        let row = $(btn).closest('tr');
        row.find('.tick-switch').prop('disabled', false); // ÙØªØ­ Ø§Ù„ØµØ§Ø­Ø§Øª
        row.addClass('table-warning'); // ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙ
        $(btn).text('ğŸ”“ Ù…ÙØªÙˆØ­').prop('disabled', true);
    } else {
        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£!");
    }
}

// 2. ÙˆØ¸ÙŠÙØ© Ø­ÙØ¸ ÙƒÙ„ Ø´ÙŠØ¡ (ØªØ±Ø³Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù€ app.py)
function saveAllChanges() {
    let pwd = prompt("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸ØŸ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:");
    if (!pwd) return;

    let updates = {};
    $('#client-table tbody tr').each(function() {
        let rowIndex = $(this).data('row');
        updates[rowIndex] = {};
        $(this).find('.tick-switch').each(function() {
            updates[rowIndex][$(this).data('col')] = $(this).is(':checked') ? "TRUE" : "FALSE";
        });
    });

    fetch('/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ password: pwd, updates: updates })
    }).then(r => r.json()).then(res => {
        if(res.status === 'success') alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Google Sheets âœ…");
        else alert("Ø®Ø·Ø£: " + res.message);
    });
}
</script>
</body>
</html>
